# Alembic Usage Guide

This project uses Alembic for database migrations. All database schema changes should be managed through Alembic migrations.

## Current Migrations

- **001_add_projects_tasks_tables**: Creates `projects`, `tasks`, and `project_configs` tables

## Common Commands

### Check Migration Status

```bash
cd mapper/backend
uv run alembic current
```

### View Migration History

```bash
uv run alembic history
```

### Apply All Pending Migrations

```bash
uv run alembic upgrade head
```

### Create a New Migration

```bash
# Auto-generate migration from model changes
uv run alembic revision --autogenerate -m "description_of_changes"

# Create empty migration file
uv run alembic revision -m "description_of_changes"
```

### Rollback Migrations

```bash
# Rollback one migration
uv run alembic downgrade -1

# Rollback to specific revision
uv run alembic downgrade <revision>

# Rollback all migrations
uv run alembic downgrade base
```

## Migration Files Location

Migrations are stored in: `mapper/backend/alembic/versions/`

## Configuration

Alembic configuration is in:
- `mapper/backend/alembic.ini` - Main configuration file
- `mapper/backend/alembic/env.py` - Environment setup (reads DATABASE_URL from environment)

The `env.py` file automatically:
- Reads `DATABASE_URL` from environment variables
- Converts asyncpg URLs to psycopg2 for synchronous migrations
- Imports all models from `app.models` for autogenerate

## Best Practices

1. **Always review autogenerated migrations** before applying them
2. **Test migrations** on a development database first
3. **Never edit existing migrations** that have been applied to production
4. **Create new migrations** for schema changes instead of modifying old ones
5. **Use descriptive migration messages** that explain what changed

## Troubleshooting

### Migration fails with "database does not exist"

Create the database first:
```bash
psql -U postgres -c "CREATE DATABASE agentic_qa;"
```

Or use the setup script:
```bash
uv run python scripts/setup_database.py
```

### Migration fails with "relation already exists"

The tables may have been created manually. You can:
1. Mark the migration as applied: `uv run alembic stamp head`
2. Or drop the tables and re-run migrations

### Check what migrations are pending

```bash
uv run alembic current  # Shows current revision
uv run alembic history  # Shows all revisions
```
